"use strict";(self.webpackChunkpublic_docs=self.webpackChunkpublic_docs||[]).push([[829],{7515:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>s,contentTitle:()=>l,default:()=>h,frontMatter:()=>o,metadata:()=>a,toc:()=>c});const a=JSON.parse('{"id":"command-line-tutorial","title":"Command Line Tutorial","description":"Learn Divvi Up via a local instance of all Divvi Up components running via","source":"@site/docs/command-line-tutorial.md","sourceDirName":".","slug":"/command-line-tutorial","permalink":"/command-line-tutorial","draft":false,"unlisted":false,"editUrl":"https://github.com/divviup/public-docs/tree/main/docs/command-line-tutorial.md","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"sidebar_position":3,"title":"Command Line Tutorial"},"sidebar":"docSidebar","previous":{"title":"How It Works","permalink":"/how-it-works"},"next":{"title":"Video Demo","permalink":"/command-line-video-demo"}}');var i=t(4848),r=t(8453);const o={sidebar_position:3,title:"Command Line Tutorial"},l="Divvi Up Command Line Tutorial",s={},c=[{value:"Requirements",id:"requirements",level:2},{value:"Install <code>divviup</code>",id:"install-divviup",level:3},{value:"Download <code>compose.yaml</code>",id:"download-composeyaml",level:3},{value:"Start Divvi Up",id:"start-divvi-up",level:2},{value:"Configure Auth",id:"configure-auth",level:2},{value:"Configure Leader and Helper Aggregator",id:"configure-leader-and-helper-aggregator",level:2},{value:"Collector Credential",id:"collector-credential",level:2},{value:"Create a Task",id:"create-a-task",level:2},{value:"Upload Measurement Reports",id:"upload-measurement-reports",level:2},{value:"Collect the Aggregated Value",id:"collect-the-aggregated-value",level:2},{value:"Next Steps",id:"next-steps",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"divvi-up-command-line-tutorial",children:"Divvi Up Command Line Tutorial"})}),"\n",(0,i.jsxs)(n.p,{children:["Learn Divvi Up via a local instance of all Divvi Up components running via\n",(0,i.jsx)(n.code,{children:"docker compose"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"Following this tutorial will:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Install required software and tools"}),"\n",(0,i.jsx)(n.li,{children:"Run Divvi Up and a pair of aggregators locally in Docker"}),"\n",(0,i.jsx)(n.li,{children:"Shard some measurements into reports and upload them, simulating DAP clients"}),"\n",(0,i.jsx)(n.li,{children:"Collect the results of an aggregation"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["If any of these terms are unfamiliar please read the\n",(0,i.jsx)(n.a,{href:"./how-it-works",children:"How it Works"})," doc."]}),"\n",(0,i.jsx)(n.h2,{id:"requirements",children:"Requirements"}),"\n",(0,i.jsx)(n.p,{children:"To get started, you'll need:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"A Unix like shell on macOS, Linux or Windows"}),"\n",(0,i.jsxs)(n.li,{children:["A ",(0,i.jsx)(n.code,{children:"divviup"})," binary (see instructions below)"]}),"\n",(0,i.jsxs)(n.li,{children:["A ",(0,i.jsx)(n.code,{children:"compose.yaml"})," (see instructions below)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"https://docs.docker.com/get-docker/",children:"Docker"})," and\n",(0,i.jsx)(n.a,{href:"https://docs.docker.com/compose/install/",children:"Docker Compose"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["If you are unable to meet these requirements or would prefer to watch this\ntutorial being performed as a video see the\n",(0,i.jsx)(n.a,{href:"./command-line-video-demo",children:"command line video demo"})]}),"\n",(0,i.jsxs)(n.h3,{id:"install-divviup",children:["Install ",(0,i.jsx)(n.code,{children:"divviup"})]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"divviup"})," is a command line (CLI) tool for doing basic operations on the Divvi\nUp and Distributed Aggregation Protocol (DAP) API endpoints. See\n",(0,i.jsx)(n.code,{children:"divviup --help"})," for details on all of the commands."]}),"\n",(0,i.jsxs)(n.p,{children:["The tool is available for download for macOS, Windows or Linux from the\n",(0,i.jsx)(n.a,{href:"https://github.com/divviup/divviup-api/releases",children:"divviup-api releases page"}),"."]}),"\n",(0,i.jsxs)(n.h3,{id:"download-composeyaml",children:["Download ",(0,i.jsx)(n.code,{children:"compose.yaml"})]}),"\n",(0,i.jsxs)(n.p,{children:["A ",(0,i.jsx)(n.code,{children:"compose.yaml"})," will be used to download and run all required containers to run\na Divvi Up environment."]}),"\n",(0,i.jsx)(n.p,{children:"Create a folder for this tutorial"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"mkdir divviup-tutorial\ncd divviup-tutorial\n"})}),"\n",(0,i.jsxs)(n.p,{children:["And download the latest release of the ",(0,i.jsx)(n.code,{children:"compose.yaml"})," found on the\n",(0,i.jsx)(n.a,{href:"https://github.com/divviup/divviup-api/releases",children:"divviup-api releases page"}),"\npage."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"curl -L https://github.com/divviup/divviup-api/releases/latest/download/compose.yaml > compose.yaml\n"})}),"\n",(0,i.jsx)(n.h2,{id:"start-divvi-up",children:"Start Divvi Up"}),"\n",(0,i.jsxs)(n.p,{children:["First, get Divvi Up running locally. In your shell, navigate to the directory\ncontaining ",(0,i.jsx)(n.code,{children:"compose.yaml"})," and run:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"docker compose up --wait\n"})}),"\n",(0,i.jsx)(n.p,{children:"This will:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"deploy two Janus aggregators to act as leader and helper in your tasks"}),"\n",(0,i.jsx)(n.li,{children:"deploy the Divvi Up control plane to coordinate the aggregators"}),"\n",(0,i.jsx)(n.li,{children:"pair the aggregators with the control plane to make them available for use in\ntask definitions"}),"\n",(0,i.jsx)(n.li,{children:'create an account named "demo"'}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"configure-auth",children:"Configure Auth"}),"\n",(0,i.jsxs)(n.p,{children:["Set an environment variable to direct ",(0,i.jsx)(n.code,{children:"divviup"})," to use your local control plane\nand to use an empty API token:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:'export DIVVIUP_API_URL=http://localhost:8080\nexport DIVVIUP_TOKEN=""\n'})}),"\n",(0,i.jsx)(n.p,{children:"Next, obtain the ID of the demo account:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"divviup account list\n"})}),"\n",(0,i.jsx)(n.p,{children:'You should get a single account back with the name "demo", like this:'}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'[\n  {\n    "id": "8ea1fc65-a669-48dd-96ac-c920fcb0ae90",\n    "name": "demo",\n    "created_at": "2024-06-14T22:48:00.683659Z",\n    "updated_at": "2024-06-14T22:48:00.683659Z",\n    "admin": false\n  }\n]\n'})}),"\n",(0,i.jsx)(n.p,{children:"Now, set an environment variable for the account ID:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"# Substitute the account ID that was generated by your Divvi Up instance\nexport DIVVIUP_ACCOUNT_ID=8ea1fc65-a669-48dd-96ac-c920fcb0ae90\n"})}),"\n",(0,i.jsx)(n.h2,{id:"configure-leader-and-helper-aggregator",children:"Configure Leader and Helper Aggregator"}),"\n",(0,i.jsx)(n.p,{children:"List the aggregators and identify the ID of both a leader and a helper."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"divviup aggregator list\n"})}),"\n",(0,i.jsx)(n.p,{children:"The output will contain JSON objects like:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'  {\n    "id": "3650870b-56e6-4eac-8944-b7ca36569b33",\n    "role": "Either",\n    "name": "Divvi Up staging-dap-09-1",\n    "dap_url": "https://staging-dap-09-1.api.example.com/",\n    "api_url": "https://staging-dap-09-1.api.example.com/aggregator-api",\n    "is_first_party": true,\n    "vdafs": [\n      "Prio3Count",\n      "Prio3Sum",\n      "Prio3Histogram",\n      "Prio3SumVec"\n    ],\n    "query_types": [\n      "TimeInterval",\n      "FixedSize"\n    ],\n    "protocol": "DAP-09",\n    "features": [\n      "TokenHash",\n      "TimeBucketedFixedSize",\n      "UploadMetrics"\n    ]\n  },\n  {\n    "id": "96301951-c848-4a57-b4f5-32812e4db1be",\n    "account_id": null,\n    "created_at": "2024-03-21T22:47:15.467139Z",\n    "updated_at": "2024-04-18T17:33:30.439465Z",\n    "deleted_at": null,\n    "role": "Either",\n    "name": "Divvi Up staging-dap-09-2",\n    "dap_url": "https://staging-dap-09-2.api.example.com/",\n    "api_url": "https://staging-dap-09-2.api.example.com/aggregator-api",\n    "is_first_party": false,\n    "vdafs": [\n      "Prio3Count",\n      "Prio3Sum",\n      "Prio3Histogram",\n      "Prio3SumVec"\n    ],\n    "query_types": [\n      "TimeInterval",\n      "FixedSize"\n    ],\n    "protocol": "DAP-09",\n    "features": [\n      "TokenHash",\n      "UploadMetrics",\n      "TimeBucketedFixedSize"\n    ]\n  }\n'})}),"\n",(0,i.jsx)(n.p,{children:"Set the two IDs into environment variables. NOTE: These IDs will vary based on\nyour configuration."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"# Substitute the leader and helper aggregator IDs that were generated by your Divvi Up instance\nexport LEADER_ID=3650870b-56e6-4eac-8944-b7ca36569b33\nexport HELPER_ID=96301951-c848-4a57-b4f5-32812e4db1be\n"})}),"\n",(0,i.jsx)(n.h2,{id:"collector-credential",children:"Collector Credential"}),"\n",(0,i.jsx)(n.p,{children:"Next, generate a collector-credential for the task. The collector credential\nwill be used by the collector to export the aggregated telemetry."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"divviup collector-credential generate --save\n"})}),"\n",(0,i.jsx)(n.p,{children:"The output will be like:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:'{\n  "id": "0a0f8ea8-b603-4416-b138-b7f217153bb7",\n  "hpke_config": {\n    "id": 144,\n    "kem_id": "X25519HkdfSha256",\n    "kdf_id": "HkdfSha256",\n    "aead_id": "Aes128Gcm",\n    "public_key": "V9IpdJxS91MHPiNTjwDk9DFS-5M_neVrPxlmvolmTTo"\n  },\n  "created_at": "2024-05-03T15:23:56.624726Z",\n  "deleted_at": null,\n  "updated_at": "2024-05-03T15:23:56.624727Z",\n  "name": "collector-credential-144",\n  "token_hash": "VItYJdAyWYIvooe8GzkGnVTvaMkvWc9G-eiwxudfWww",\n  "token": "A6JDAYPiYDXmNyh-OpYXGw"\n}\n\nSaved new collector credential to /your/current/directory/collector-credential-144.json. Keep this file safe!\n'})}),"\n",(0,i.jsx)(n.admonition,{type:"warning",children:(0,i.jsx)(n.p,{children:"This credential isn't sensitive because it's only useful in your local instance\nof Divvi Up. But collector credentials generated against the production service\nshould be carefully managed. Consider using a password manager to protect them."})}),"\n",(0,i.jsx)(n.p,{children:"Make a note of the path where the credential was saved, and save the collector\ncredential ID to an environment variable."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"# Substitute the collector credential path and ID that were generated by your Divvi Up instance\nexport COLLECTOR_CREDENTIAL_PATH=/your/current/directory/collector-credential-144.json\nexport COLLECTOR_CREDENTIAL_ID=0a0f8ea8-b603-4416-b138-b7f217153bb7\n"})}),"\n",(0,i.jsx)(n.h2,{id:"create-a-task",children:"Create a Task"}),"\n",(0,i.jsx)(n.p,{children:"Create the the histogram task. In this case the task is a set of values from 0\nto 10 for use in collecting a net-promoter score for a survey."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:" divviup task create --name net-promoter-score \\\n    --leader-aggregator-id $LEADER_ID --helper-aggregator-id $HELPER_ID \\\n    --collector-credential-id $COLLECTOR_CREDENTIAL_ID \\\n    --vdaf histogram --categorical-buckets 0,1,2,3,4,5,6,7,8,9,10 \\\n    --min-batch-size 100 --max-batch-size 200 --time-precision 60sec\n"})}),"\n",(0,i.jsx)(n.p,{children:"The output will contain a JSON object:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n  "id": "Siwa4QTEnQXMfRPyhir8AzS4EBqfTebmEzKfvajDgYk",\n  "account_id": "a9c571ba-5f3d-4814-8d8b-c5bb0f5030b7",\n  "name": "net-promoter-score",\n  "vdaf": {\n    "type": "histogram",\n    "buckets": ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10"],\n    "chunk_length": 4\n  },\n  "min_batch_size": 100,\n  "max_batch_size": null,\n  "created_at": "2024-05-03T15:27:56.229891Z",\n  "updated_at": "2024-05-03T15:27:56.229891Z",\n  "time_precision_seconds": 60,\n  "report_count": 0,\n  "aggregate_collection_count": 0,\n  "expiration": "2025-05-03T15:27:55.88511Z",\n  "leader_aggregator_id": "3650870b-56e6-4eac-8944-b7ca36569b33",\n  "helper_aggregator_id": "96301951-c848-4a57-b4f5-32812e4db1be",\n  "collector_credential_id": "0a0f8ea8-b603-4416-b138-b7f217153bb7",\n  "report_counter_interval_collected": 0,\n  "report_counter_decode_failure": 0,\n  "report_counter_decrypt_failure": 0,\n  "report_counter_expired": 0,\n  "report_counter_outdated_key": 0,\n  "report_counter_success": 0,\n  "report_counter_too_early": 0,\n  "report_counter_task_expired": 0\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:"Save the ID of the task into an environment variable."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"# Substitute the task ID that was generated by your Divvi Up instance\nexport TASK_ID=Siwa4QTEnQXMfRPyhir8AzS4EBqfTebmEzKfvajDgYk\n"})}),"\n",(0,i.jsx)(n.h2,{id:"upload-measurement-reports",children:"Upload Measurement Reports"}),"\n",(0,i.jsx)(n.p,{children:"Upload a random set of 150 measurements."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"for i in {1..150}; do\n  measurement=$(( $RANDOM % 10 ))\n  divviup dap-client upload --task-id $TASK_ID --measurement $measurement;\ndone\n"})}),"\n",(0,i.jsx)(n.p,{children:'Note that the random measurements will only be between 0 and 9 inclusive, while\nthe buckets were created for measurements between 0 and 10 inclusive. This will\nleave the "10" bucket empty for demonstration purposes.'}),"\n",(0,i.jsx)(n.p,{children:"Wait a little while to let the aggregators run the aggregation jobs. Then, get\ncollection results:"}),"\n",(0,i.jsx)(n.h2,{id:"collect-the-aggregated-value",children:"Collect the Aggregated Value"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"divviup dap-client collect \\\n    --task-id $TASK_ID \\\n    --collector-credential-file $COLLECTOR_CREDENTIAL_PATH \\\n    --current-batch\n"})}),"\n",(0,i.jsx)(n.p,{children:"You will get a result like:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"Number of reports: 113\nInterval start: 2024-06-05 21:31:00 UTC\nInterval end: 2024-06-05 21:34:00 UTC\nInterval length: 180s\nAggregation result: [14, 10, 10, 13, 13, 8, 16, 13, 9, 7, 0]\ncollection: Collection { partial_batch_selector: PartialBatchSelector { batch_identifier: BatchId(wPLBlC6iHWp_YBBAYP_ig5nal0FOz1QlLSaC42U7sm0) }, report_count: 113, interval: (2024-06-05T21:31:00Z, TimeDelta { secs: 180, nanos: 0 }), aggregate_result: [14, 10, 10, 13, 13, 8, 16, 13, 9, 7, 0] }\n"})}),"\n",(0,i.jsx)(n.p,{children:'If you get an error like "The batch implied by the query is invalid", then the\naggregators are still working on processing your uploaded reports. Given them a\nfew more minutes.'}),"\n",(0,i.jsx)(n.p,{children:"If you get fewer reports in the collection than you uploaded, that's because you\nsent the collection request too soon and not all the reports were prepared yet.\nThose reports will be available in a later collection, after enough additional\nreports are uploaded to meet the minimum batch size."}),"\n",(0,i.jsx)(n.h2,{id:"next-steps",children:"Next Steps"}),"\n",(0,i.jsxs)(n.p,{children:["Congratulations! You've just used secure multi-party computation to do a\nprivacy-preserving aggregation over secret shares of measurements. Now you can\ntry experimenting with different tasks. Try creating different histograms with\ndifferent numbers of buckets, or see if you can use ",(0,i.jsx)(n.code,{children:"Prio3SumVec"})," to compute\nsums over bit vectors."]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>l});var a=t(6540);const i={},r=a.createContext(i);function o(e){const n=a.useContext(r);return a.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),a.createElement(r.Provider,{value:n},e.children)}}}]);